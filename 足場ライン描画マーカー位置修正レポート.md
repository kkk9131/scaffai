# 足場ライン描画マーカー位置修正レポート

## 問題の概要

建物ライン編集後の高度計算による足場ライン描画機能において、ラインは正しく作図できるが、マーカーの位置が正しく出力されない問題が発生していました。

### 問題の詳細

ユーザーの建物形状（L字型）：
```
1---2
|      |
|      3--4
|             |
6------5
```

期待される動作：
- 1-2は北面（北面の総スパンから計算結果の3-4をひいたもの）
- 2-3,4-5は東面（東の総スパンから計算結果の2-3を引いたもの）
- 5-6は南面（入隅部分がないのでそのまま維持）
- 6-1は西面（入隅部分がないのでそのまま維持）

実際の問題：
- スパン構成がそれぞれ逆になったり反転したりしている
- マーカーの位置が期待と異なる

## 修正内容

### 1. 辺の方向判定の修正

**ファイル**: `apps/web/components/DrawingCanvas/utils/geometryCalculator.ts`

**修正箇所**: `getEdgeFaceDirection`関数

**変更内容**:
- 従来の法線ベクトルベースの判定から、辺のベクトル方向による判定に変更
- ユーザーの期待する辺と面の対応関係に合わせて調整：
  - 東向きの辺 → 北面
  - 南向きの辺 → 東面
  - 西向きの辺 → 南面
  - 北向きの辺 → 西面

### 2. スパンマーカー生成の改善

**ファイル**: `apps/web/components/DrawingCanvas/utils/scaffoldLineGenerator.ts`

**修正箇所**: `generateSpanMarkers`関数

**変更内容**:
- スパン構成の配置ロジックを改善
- 実寸法（mm）とピクセル長さの関係を正しく処理
- マーカー配置の精度向上
- デバッグログの追加

### 3. 入隅計算結果の適用改善

**ファイル**: `apps/web/components/DrawingCanvas/utils/scaffoldLineGenerator.ts`

**修正箇所**: `generateScaffoldLine`関数

**変更内容**:
- 入隅計算結果を面ごとに整理する機能を追加
- 同じ面の計算結果を他の辺にも適用できるロジックを実装
- 「総スパンから計算結果を引く」処理の実装
- 直接計算結果がない辺に対する面内計算結果の適用

## 技術的な改善点

### 面ごとの計算結果管理

```typescript
// 入隅計算結果を面ごとに整理
const faceCalculations: { [face: string]: AdvancedCalculationResult[] } = {
  north: [],
  east: [],
  south: [],
  west: []
};
```

### スパン構成の調整ロジック

```typescript
// 残りスパン = 辺の長さ - 入隅部分
const remainingSpan = edgeLengthMm - totalOriginalSpan;

if (remainingSpan > 0) {
  // 残りスパンを適切に分割
  spanConfig = [Math.round(remainingSpan)];
}
```

### マーカー配置の精度向上

```typescript
// スパン構成は実寸法（mm）で指定されているため、
// 現在の縮尺を考慮してピクセル長さとの比較を行う
const totalSpanLength = spanConfiguration.reduce((sum, span) => sum + span, 0);
```

## 期待される効果

1. **正確なマーカー位置**: L字型建物での各辺のマーカーが期待される位置に配置される
2. **入隅計算の正しい適用**: 入隅辺の計算結果が隣接する面の辺に正しく反映される
3. **スパン構成の正確性**: 「総スパンから入隅部分を引く」処理が正しく動作する
4. **デバッグ能力の向上**: 詳細なログ出力により問題の特定が容易になる

## 検証項目

修正後は以下の点を確認してください：

1. L字型建物でのマーカー位置が期待通りに配置されているか
2. 北面の1-2辺が「総スパンから3-4の計算結果を引いた」スパン構成になっているか
3. 東面の4-5辺が「総スパンから2-3の計算結果を引いた」スパン構成になっているか
4. 南面・西面の入隅のない辺が正しく維持されているか
5. コンソールログで各辺の計算過程が確認できるか

## 注意事項

- 修正は既存の四角形建物の処理には影響しないよう設計されています
- L字型以外の複雑な形状については追加の調整が必要な場合があります
- デバッグログは本番環境では削除することを推奨します