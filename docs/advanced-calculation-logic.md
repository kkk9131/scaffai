# 高度計算機能の入隅計算ロジック

## 概要

ユーザーが作図エディタで編集した建物形状に対して、入隅部分の足場離れとスパン構成を自動計算する機能のロジック仕様書。

## 建物形状の例

```
1-----2  (北面: 1-2)
|     |
|   4-3  (東面: 2-3, 南面: 3-4 + 4-5)
|   |
6---5    (南面: 5-6, 西面: 6-1)
```

### 面の構成
- **北面**: 1-2
- **東面**: 2-3
- **南面**: 3-4 + 4-5 + 5-6
- **西面**: 6-1

### 入隅の特定
- **入隅頂点**: 4
- **入隅辺**: 3-4 と 4-5

## 簡易計算の前提条件

### 入力データ
- **建物外周距離**: 1-2から2-5までの実際の建物外周距離
- **各面の総スパン**: 面ごとの足場スパン合計
- **外周辺の離れ**: 1-2, 2-3, 5-6, 6-1の既計算済み離れ
- **足場ライン頂点座標**: 簡易計算で生成された足場ライン形状

## 入隅計算の核心ロジック

### 1. 基本計算式

```
入隅辺の離れ = 隣接外周辺の離れ + 隣接入隅辺の長さ - 隣接入隅辺のスパン構成
```

### 2. 具体的な計算

#### 4-5辺の離れ計算
```
4-5の離れ = 2-3の離れ（現在の離れ）+ 3-4の長さ（割付距離）- 3-4のスパン構成
```

#### 3-4辺の離れ計算
```
3-4の離れ = 5-6の離れ（現在の離れ）+ 4-5の長さ（割付距離）- 4-5のスパン構成
```

### 3. 出隅部分のスパン配分

各面の総スパンから入隅辺のスパン構成を引いた残りを出隅部分に配分する。

#### 南面の例
```
5-6のスパン構成 = 南面の総スパン - 3-4のスパン構成 - 4-5のスパン構成
```

#### 東面の例
```
2-3のスパン構成 = 東面の総スパン - (東面に含まれる入隅辺のスパン構成)
```

## 制約条件

### 1. 足場ライン制約
- **制約**: 計算結果の足場ラインが既存の足場ライン矩形からはみ出してはいけない
- **理由**: 外周の簡易計算で求めた離れが無効になるため

### 2. 距離制約
- **最小制限**: 軒の出 + 80mm
- **境界線制限**: 境界線 - 60mm（存在する場合）

### 3. 補正処理
- 制約を満たさない場合は補正部材（900, 600, 355, 300, 150mm）で調整

## 計算手順

### Phase 1: 入隅検出
1. ユーザー編集後の建物頂点座標を取得
2. 各頂点の内角を計算（180度超が入隅）
3. 入隅頂点と入隅辺を特定

### Phase 2: 入隅辺の離れ計算
1. 各入隅辺に対して基本計算式を適用
2. QuickAllocationCalculatorで最適なスパン構成を決定
3. 制約条件をチェックし、必要に応じて補正

### Phase 3: 出隅部分のスパン配分
1. 各面の総スパンから入隅辺のスパン構成を減算
2. 残りスパンを出隅辺に配分

### Phase 4: 足場ライン整合性チェック
1. 計算結果で足場ライン頂点座標を生成
2. 既存の足場ライン矩形からのはみ出しをチェック
3. はみ出す場合は調整処理を実行

## 使用する既存機能

### 計算エンジン
- **QuickAllocationCalculator**: 入隅辺のスパン構成最適化
- **geometryCalculator**: 入隅検出と角度計算

### データ構造
- **BuildingVertex[]**: 建物頂点座標
- **EdgeEave[]**: 軒の出距離
- **ScaffoldLineData**: 足場ライン座標データ

## 期待される結果

1. **自動入隅検出**: ユーザー編集に関係なく入隅を正確に特定
2. **最適化された離れ**: 各入隅辺で最適な足場離れを計算
3. **整合性保持**: 簡易計算結果との整合性を維持
4. **UI連携**: 計算結果を作図エディタに自動反映

## 実装上の注意点

1. **計算順序**: 入隅辺間の依存関係を考慮した計算順序
2. **エラーハンドリング**: 制約を満たせない場合の適切な処理
3. **パフォーマンス**: リアルタイム計算のための最適化
4. **ユーザビリティ**: 計算結果の分かりやすい表示